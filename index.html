<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sequential Markers â€” Minimal</title>

  <!-- A-Frame + AR.js (absolute URLs) -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    .hint {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      color: yellow;
      font-weight: 700;
      text-shadow: 0 0 6px black;
      z-index: 10000;
      pointer-events: none;
      display: none;
    }
  </style>
</head>
<body>
  <div id="hint" class="hint"></div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-assets id="assets"></a-assets>

    <a-nft id="markerA" type="nft" url="https://lucian-lu.github.io/trm-lab-2/nft/subway_ticket/subway_ticket"></a-nft>
    <a-nft id="markerB" type="nft" url="https://lucian-lu.github.io/trm-lab-2/nft/ramen_menu/ramen_menu"></a-nft>
    <a-nft id="markerC" type="nft" url="https://lucian-lu.github.io/trm-lab-2/nft/ramen_bar_entrance/ramen_bar_entrance"></a-nft>

    <a-entity camera>
      <a-text
        id="startText"
        value="I feel quite hungry!"
        position="-1 0 -2"
        color="yellow"
        width="5"
        scale="0.5 0.5 0.5"
      ></a-text>
    </a-entity>
  </a-scene>

<script>
  const hintEl = document.getElementById('hint');
  const assets = document.getElementById('assets');
  const startText = document.getElementById('startText');

  const state = { scannedA: false, scannedB: false, loaded: { A: false, B: false, C: false } };

const modelConfig = {
  A: {
    path: "https://lucian-lu.github.io/trm-lab-2/models/test.glb",
    scale: "200 200 200",
    label: "little_tokyo"
  },
  B: {
    path: "https://lucian-lu.github.io/trm-lab-2/models/test.glb",
    scale: "200 200 200",
    label: "sushi_bar"
  },
  C: {
    path: "https://lucian-lu.github.io/trm-lab-2/models/test.glb",
    scale: "200 200 200",
    label: "ramen"
  }
};

  const mA = document.getElementById('markerA');
  const mB = document.getElementById('markerB');
  const mC = document.getElementById('markerC');

  function showHint(msg, time = 3000){
    hintEl.textContent = msg;
    hintEl.style.display = 'block';
    setTimeout(()=>{ hintEl.style.display = 'none'; }, time);
  }

  function createWrapperIfNeeded(markerEl, cfg){
    if(markerEl._wrapper) return;
    const wrapper = document.createElement('a-entity');
    wrapper.setAttribute('visible','false');
    wrapper.setAttribute('scale', cfg.scale || '100 100 100');
    wrapper.setAttribute('rotation','-90 0 0');
    markerEl.appendChild(wrapper);
    markerEl._wrapper = wrapper;
  }

  function createAssetItemForKey(key, cfg){
    const assetId = `asset-${key}`;
    if(document.getElementById(assetId)) return document.getElementById(assetId);
    const absoluteUrl = new URL(cfg.path, window.location.href).href;
    const ai = document.createElement('a-asset-item');
    ai.setAttribute('id', assetId);
    ai.setAttribute('src', absoluteUrl);
    ai.setAttribute('crossorigin', 'anonymous');
    assets.appendChild(ai);
    return ai;
  }

  function loadModel(markerEl, key){
    if(!modelConfig[key] || state.loaded[key]) return;
    const cfg = modelConfig[key];

    createWrapperIfNeeded(markerEl, cfg);
    createAssetItemForKey(key, cfg);

    const modelEl = document.createElement('a-entity');
    modelEl.setAttribute('gltf-model', `#asset-${key}`);
    modelEl.setAttribute('scale', cfg.scale);
    modelEl.setAttribute('animation-mixer', '');
    modelEl.setAttribute('visible', 'false');

    modelEl.addEventListener('model-loaded', ()=>{
      state.loaded[key] = true;
      markerEl._wrapper.setAttribute('visible','true');
      modelEl.setAttribute('visible','true');
      showHint(`Model ${cfg.label} loaded`, 1500);
    });

    modelEl.addEventListener('error', ()=>{
      showHint('Error loading model', 3000);
    });

    markerEl._wrapper.appendChild(modelEl);
  }

  createWrapperIfNeeded(mA, modelConfig.A);
  createWrapperIfNeeded(mB, modelConfig.B);
  createWrapperIfNeeded(mC, modelConfig.C);

  mA.addEventListener('markerFound', ()=>{
    if(!state.loaded.A) loadModel(mA,'A');
    state.scannedA = true;
    if(startText) startText.setAttribute('visible', 'false');
    showHint('First marker scanned', 1500);
  });

  mB.addEventListener('markerFound', ()=>{
    if(!state.scannedA){
      showHint('Scan first marker first', 2000);
      return;
    }
    if(!state.loaded.B) loadModel(mB,'B');
    state.scannedB = true;
    showHint('Second marker scanned', 1500);
  });

  mC.addEventListener('markerFound', ()=>{
    if(!state.scannedB){
      showHint('Scan second marker first', 2000);
      return;
    }
    if(!state.loaded.C) loadModel(mC,'C');
    showHint('Third marker scanned', 1500);
  });
</script>
</body>
</html>
