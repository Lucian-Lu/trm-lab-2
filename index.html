<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sequential Markers — Fixed & Test Message</title>

  <!-- A-Frame + AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0; left: 0;
      background-color: rgba(0,0,0,0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .arjs-loader div { text-align:center; font-size:1.25em; color:white; }
    .hint {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      color: yellow;
      font-weight: 700;
      text-shadow: 0 0 6px black;
      z-index: 10000;
      pointer-events: none;
    }
    .test-msg {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: cyan;
      font-weight: bold;
      text-shadow: 0 0 6px black;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div class="arjs-loader"><div>Loading AR system — please wait...</div></div>
  <div id="hint" class="hint" style="display:none"></div>
  <div id="testMsg" class="test-msg">TEST: AR system initialized!</div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-nft id="markerA" type="nft" url="nft/subway_ticket/subway_ticket"
        smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
    </a-nft>

    <a-nft id="markerB" type="nft" url="nft/ramen_menu/ramen_menu"
        smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
    </a-nft>

    <a-nft id="markerC" type="nft" url="nft/ramen_bar_entrance/ramen_bar_entrance"
        smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

<script>
  const state = { scannedA: false, scannedB: false, loaded: { A: false, B: false, C: false } };
  const hintEl = document.getElementById('hint');
  const loaderEl = document.querySelector('.arjs-loader');

    const modelConfig = {
    A: { path: 'models/little_tokyo.glb', scale: '200 200 200', label: 'little_tokyo' },
    B: { path: 'models/ramen_bar.glb', scale: '200 200 200', label: 'sushi_bar' },
    C: { path: 'models/ramen.glb', scale: '200 200 200', label: 'ramen' }
    };

  const mA = document.getElementById('markerA');
  const mB = document.getElementById('markerB');
  const mC = document.getElementById('markerC');

  function showHint(msg, time=2000){
    hintEl.textContent = msg;
    hintEl.style.display = 'block';
    setTimeout(()=>{ hintEl.style.display='none'; }, time);
  }

  function createLazyModel(markerEl, cfg){
    if(markerEl._lazyAdded) return;
    markerEl._lazyAdded = true;
    const wrapper = document.createElement('a-entity');
    wrapper.setAttribute('visible','false');
    wrapper.setAttribute('scale',cfg.scale || '100 100 100');
    markerEl.appendChild(wrapper);
    markerEl._wrapper = wrapper;
  }

  function loadModel(markerEl,key){
    if(!modelConfig[key] || state.loaded[key]) return;
    const cfg = modelConfig[key];
    createLazyModel(markerEl,cfg);

    const modelEl = document.createElement('a-entity');
    modelEl.setAttribute('gltf-model',cfg.path);
    modelEl.setAttribute('scale',cfg.scale);
    modelEl.setAttribute('animation-mixer','');

    let timeout = setTimeout(()=>{ showHint('Model load timeout, maybe large file',4000); },15000);
    modelEl.addEventListener('model-loaded',()=>{ clearTimeout(timeout); state.loaded[key]=true; markerEl._wrapper.setAttribute('visible','true'); loaderEl.style.display='none'; });
    modelEl.addEventListener('error',()=>{ clearTimeout(timeout); showHint('Error loading model',4000); });

    markerEl._wrapper.appendChild(modelEl);
  }

  createLazyModel(mA,modelConfig.A);
  createLazyModel(mB,modelConfig.B);
  createLazyModel(mC,modelConfig.C);

  mA.addEventListener('markerFound',()=>{ if(!state.loaded.A) loadModel(mA,'A'); state.scannedA=true; showHint('First marker scanned'); });
  mB.addEventListener('markerFound',()=>{ if(!state.scannedA){ showHint('Scan first marker'); return; } if(!state.loaded.B) loadModel(mB,'B'); state.scannedB=true; showHint('Second marker scanned'); });
  mC.addEventListener('markerFound',()=>{ if(!state.scannedB){ showHint('Scan second marker'); return; } if(!state.loaded.C) loadModel(mC,'C'); showHint('Third marker scanned'); });

  // remove loader after 10s max
  window.addEventListener('load',()=>{ setTimeout(()=>loaderEl.style.display='none',10000); });
</script>
</body>
</html>
